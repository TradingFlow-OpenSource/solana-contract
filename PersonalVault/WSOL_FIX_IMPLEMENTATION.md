# ğŸ”§ WSOL Swap ä¿®å¤å®æ–½æ–‡æ¡£

## ğŸ“‹ é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
ä½¿ç”¨ WSOL è¿›è¡Œ swap æ—¶ï¼ŒTypeScript æ— æ³•å…³é—­ä¸´æ—¶ WSOL è´¦æˆ·ï¼Œå› ä¸ºï¼š
1. ä¸´æ—¶è´¦æˆ·çš„ owner æ˜¯ `vaultPda`ï¼ˆPDAï¼‰
2. å…³é—­è´¦æˆ·éœ€è¦ owner ç­¾å
3. TypeScript æ— æ³•æä¾› PDA ç­¾å

### æ–¹æ¡ˆ 1 çš„ç¼ºé™·
`WSOL_FIX_GUIDE.md` ä¸­æåˆ°çš„æ–¹æ¡ˆ 1ï¼ˆçº¯ TypeScript ç«¯å¤„ç†ï¼‰**æ— æ³•å·¥ä½œ**ï¼Œå› ä¸ºï¼š
- TypeScript å¯ä»¥åˆ›å»ºä¸´æ—¶è´¦æˆ·
- TypeScript å¯ä»¥å‘é€ swap æŒ‡ä»¤
- **ä½† TypeScript æ— æ³•å…³é—­ä¸´æ—¶è´¦æˆ·**ï¼ˆç¼ºå°‘ PDA ç­¾åï¼‰

---

## âœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼šæ··åˆæ–¹æ¡ˆï¼ˆRust + TypeScriptï¼‰

### æ¶æ„è®¾è®¡

```
TypeScript ç«¯:
1. æ£€æµ‹ WSOL è¾“å…¥
2. åˆ›å»ºä¸´æ—¶è´¦æˆ· (CreateAccount + InitializeAccount)
3. å°†ä¸´æ—¶è´¦æˆ·åœ°å€ä¼ å…¥ remaining_accounts
4. å‘é€ swap æŒ‡ä»¤

åˆçº¦ç«¯ï¼ˆRustï¼‰:
1. æ¥æ”¶ä¸´æ—¶è´¦æˆ·åœ°å€
2. ä½¿ç”¨ä¸´æ—¶è´¦æˆ·æ‰§è¡Œ swap (CPI åˆ° Raydium)
3. swap æˆåŠŸåï¼Œæ£€æµ‹ä¸´æ—¶è´¦æˆ·
4. å…³é—­ä¸´æ—¶è´¦æˆ·ï¼ˆä½¿ç”¨ PDA ç­¾åï¼‰
5. ç§Ÿé‡‘è¿”å›ç»™ vault PDA
```

---

## ğŸ”¨ å®æ–½ç»†èŠ‚

### Part 1: Rust åˆçº¦ä¿®æ”¹ï¼ˆå·²å®Œæˆï¼‰

#### 1.1 ä¿®æ”¹ `raydium_clmm.rs`

æ·»åŠ äº†ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼š
- `is_temp_wsol_account()` - æ£€æµ‹æ˜¯å¦æ˜¯ä¸´æ—¶ WSOL è´¦æˆ·
- `close_temp_wsol_account()` - å…³é—­ä¸´æ—¶è´¦æˆ·

å…³é”®å®ç°ï¼š
```rust
// swap æˆåŠŸå
if account_infos.len() > 3 {
    let input_token_account = &account_infos[3]; // userInputTokenAccount
    let vault_pda = &account_infos[0]; // payer (vault PDA)
    
    if Self::is_temp_wsol_account(input_token_account, vault_pda)? {
        Self::close_temp_wsol_account(
            input_token_account,
            vault_pda,      // ç§Ÿé‡‘æ¥æ”¶è€…
            vault_pda,      // authority
            signer_seeds,
        )?;
    }
}
```

#### 1.2 ä¿®æ”¹ `raydium_amm.rs`

**é—®é¢˜ï¼š** AMM V4 çš„è´¦æˆ·ç»“æ„ä¸ CLMM ä¸åŒï¼Œvault PDA ä¸åœ¨ä¼ é€’ç»™ DEX çš„è´¦æˆ·åˆ—è¡¨ä¸­ï¼

**è´¦æˆ·ç»“æ„å¯¹æ¯”ï¼š**

**CLMM:**
```
dex_accounts[0] = payer (vault PDA) âœ…
dex_accounts[3] = userInputTokenAccount (å¯èƒ½æ˜¯ä¸´æ—¶è´¦æˆ·)
```

**AMM V4:**
```
dex_accounts[0] = TOKEN_PROGRAM_ID
dex_accounts[15] = userInputTokenAccount (å¯èƒ½æ˜¯ä¸´æ—¶è´¦æˆ·)
vault PDA ä¸åœ¨ dex_accounts ä¸­ âŒ
```

**è§£å†³æ–¹æ¡ˆï¼š**  
éœ€è¦ä¿®æ”¹ `send_trade_signal` ä¼ é€’é¢å¤–çš„ vault PDA å¼•ç”¨ç»™ AMMã€‚

---

### Part 2: TypeScript ä¿®æ”¹ï¼ˆå¾…å®Œæˆï¼‰

#### 2.1 å½“å‰å®ç°ï¼ˆtest.ts L921-1016ï¼‰

```typescript
// âœ… å·²å®ç°ï¼šåˆ›å»ºä¸´æ—¶ WSOL è´¦æˆ·
if (tokenIn.equals(WSOL_MINT)) {
  tempWsolKeypair = Keypair.generate();
  actualInputTokenAccount = tempWsolKeypair.publicKey;
  
  transaction.add(
    SystemProgram.createAccount({ ... }),
    createInitializeAccountInstruction(...)
  );
  
  // æ›¿æ¢ remainingAccounts ä¸­çš„è¾“å…¥è´¦æˆ·
  remainingAccounts[5 æˆ– 17] = actualInputTokenAccount;
}

// âŒ ä¸å·¥ä½œï¼šå°è¯•åœ¨ TypeScript å…³é—­è´¦æˆ·
if (tempWsolKeypair) {
  transaction.add(
    createCloseAccountInstruction(
      tempWsolKeypair.publicKey,
      signerKeypair.publicKey,
      vaultPda  // âŒ TypeScript æ— æ³•æä¾› PDA ç­¾åï¼
    )
  );
}
```

#### 2.2 éœ€è¦çš„ä¿®æ”¹

**ç§»é™¤ TypeScript ç«¯çš„å…³é—­æŒ‡ä»¤ï¼š**
```typescript
// ğŸ”§ æš‚æ—¶ä¸å…³é—­ä¸´æ—¶è´¦æˆ·
// TODO: éœ€è¦åˆçº¦æ”¯æŒåœ¨ swap åå…³é—­ä¸´æ—¶è´¦æˆ·
// å› ä¸ºå…³é—­è´¦æˆ·éœ€è¦ vault PDA ç­¾åï¼ŒTypeScript ç«¯æ— æ³•æä¾›
if (tempWsolKeypair) {
  console.log("\nâš ï¸  æ³¨æ„ï¼šä¸´æ—¶ WSOL è´¦æˆ·ä¸ä¼šè¢«å…³é—­ï¼ˆéœ€è¦åˆçº¦æ”¯æŒï¼‰");
  console.log("  ä¸´æ—¶è´¦æˆ·åœ°å€:", tempWsolKeypair.publicKey.toString());
}
```

**æ”¹ä¸ºï¼š**
```typescript
// âœ… åˆçº¦ç«¯ä¼šè‡ªåŠ¨å…³é—­ä¸´æ—¶è´¦æˆ·
if (tempWsolKeypair) {
  console.log("\nâœ… åˆ›å»ºäº†ä¸´æ—¶ WSOL è´¦æˆ·");
  console.log("  ä¸´æ—¶è´¦æˆ·åœ°å€:", tempWsolKeypair.publicKey.toString());
  console.log("  åˆçº¦ä¼šåœ¨ swap åè‡ªåŠ¨å…³é—­æ­¤è´¦æˆ·å¹¶å›æ”¶ç§Ÿé‡‘");
}
```

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TypeScript (test.ts)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ£€æµ‹ tokenIn == WSOL                                  â”‚
â”‚ 2. ç”Ÿæˆä¸´æ—¶ keypair                                      â”‚
â”‚ 3. æ·»åŠ  createAccount æŒ‡ä»¤                              â”‚
â”‚ 4. æ·»åŠ  initializeAccount æŒ‡ä»¤                          â”‚
â”‚ 5. æ›¿æ¢ remainingAccounts[X] ä¸ºä¸´æ—¶è´¦æˆ·                 â”‚
â”‚ 6. æ·»åŠ  sendTradeSignal æŒ‡ä»¤                            â”‚
â”‚ 7. å‘é€äº¤æ˜“ï¼ˆç­¾åè€…ï¼šsigner + tempKeypairï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆçº¦ (send_trade_signal)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. éªŒè¯æƒé™                                             â”‚
â”‚ 2. æ£€æŸ¥ä½™é¢                                             â”‚
â”‚ 3. è°ƒç”¨ DEX é›†æˆå±‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLMM/AMM (execute_swap_signed)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ„å»º swap æŒ‡ä»¤                                       â”‚
â”‚ 2. æ‰§è¡Œ CPI åˆ° Raydium (invoke_signed)                  â”‚
â”‚ 3. âœ… swap æˆåŠŸ                                         â”‚
â”‚ 4. æ£€æµ‹ä¸´æ—¶ WSOL è´¦æˆ·                                   â”‚
â”‚    - æ£€æŸ¥ owner == vault PDA                            â”‚
â”‚    - æ£€æŸ¥ mint == WSOL                                  â”‚
â”‚ 5. å…³é—­ä¸´æ—¶è´¦æˆ· (invoke_signed)                         â”‚
â”‚    - ä½¿ç”¨ vault PDA ç­¾å                                â”‚
â”‚    - ç§Ÿé‡‘è¿”å›ç»™ vault PDA                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘åˆçº¦
```bash
cd PersonalVault
anchor build
```

### 2. éƒ¨ç½²åˆçº¦ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
./dev_deploy.sh  # æˆ– ./dev_update.sh
```

### 3. è¿è¡Œæµ‹è¯•
```bash
cd test
npx ts-node test.ts
```

### 4. éªŒè¯ç»“æœ

æ£€æŸ¥äº¤æ˜“æ—¥å¿—ä¸­çš„å…³é”®ä¿¡æ¯ï¼š
```
âœ… åˆ›å»ºäº†ä¸´æ—¶ WSOL è´¦æˆ·
  ä¸´æ—¶è´¦æˆ·åœ°å€: 7EEki7Wg...
  åˆçº¦ä¼šåœ¨ swap åè‡ªåŠ¨å…³é—­æ­¤è´¦æˆ·å¹¶å›æ”¶ç§Ÿé‡‘
  
... swap æ‰§è¡Œ ...

ğŸ” æ£€æµ‹åˆ°ä¸´æ—¶ WSOL è´¦æˆ·ï¼Œå‡†å¤‡å…³é—­...
  ä¸´æ—¶è´¦æˆ·åœ°å€: 7EEki7Wg...
  Vault PDA: 5X4zZ8...
âœ… ä¸´æ—¶ WSOL è´¦æˆ·å·²å…³é—­ï¼Œç§Ÿé‡‘å·²è¿”å›
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### 1. AMM V4 æš‚ä¸æ”¯æŒè‡ªåŠ¨å…³é—­
ç”±äº AMM V4 çš„è´¦æˆ·ç»“æ„ï¼Œvault PDA ä¸åœ¨ä¼ é€’ç»™ DEX çš„è´¦æˆ·åˆ—è¡¨ä¸­ã€‚

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š**
1. ä¼˜å…ˆä½¿ç”¨ CLMM æ± å­è¿›è¡Œ WSOL swap
2. å¦‚æœå¿…é¡»ä½¿ç”¨ AMM V4ï¼Œéœ€è¦ä¿®æ”¹åˆçº¦æ¶æ„

**é•¿æœŸè§£å†³æ–¹æ¡ˆï¼š**
ä¿®æ”¹ `send_trade_signal` çš„ `remaining_accounts` ç»“æ„ï¼Œç¡®ä¿ vault PDA å§‹ç»ˆå¯è®¿é—®ã€‚

### 2. ç§Ÿé‡‘å›æ”¶
ä¸´æ—¶è´¦æˆ·çš„ç§Ÿé‡‘ï¼ˆçº¦ 0.002 SOLï¼‰ä¼šè¿”å›ç»™ vault PDAï¼Œè€Œä¸æ˜¯åŸå§‹äº¤æ˜“å‘èµ·è€…ã€‚

**å½±å“ï¼š**
- å¯¹ç”¨æˆ·é€æ˜ï¼Œvault ä½™é¢ç•¥å¾®å¢åŠ 
- ä¸å½±å“äº¤æ˜“çš„æ­£ç¡®æ€§

---

## ğŸ“ åç»­ TODO

1. âœ… ä¿®æ”¹ `raydium_clmm.rs` - æ·»åŠ å…³é—­é€»è¾‘
2. â³ ä¿®æ”¹ `raydium_amm.rs` - éœ€è¦æ¶æ„è°ƒæ•´
3. â³ æ›´æ–° `test.ts` - ç§»é™¤ TypeScript ç«¯çš„å…³é—­æŒ‡ä»¤
4. â³ æµ‹è¯• WSOL swap - éªŒè¯è‡ªåŠ¨å…³é—­
5. â³ æ›´æ–°æ–‡æ¡£ - è®°å½•æœ€ç»ˆæ–¹æ¡ˆ

---

## ğŸ¯ æ€»ç»“

**æ–¹æ¡ˆ 1ï¼ˆçº¯ TypeScriptï¼‰** âŒ ä¸å¯è¡Œ
- åŸå› ï¼šæ— æ³•æä¾› PDA ç­¾åæ¥å…³é—­ä¸´æ—¶è´¦æˆ·

**æ··åˆæ–¹æ¡ˆï¼ˆRust + TypeScriptï¼‰** âœ… å¯è¡Œ
- TypeScriptï¼šåˆ›å»ºä¸´æ—¶è´¦æˆ·
- Rustï¼šå…³é—­ä¸´æ—¶è´¦æˆ·ï¼ˆä½¿ç”¨ PDA ç­¾åï¼‰
- å·²åœ¨ CLMM ä¸­å®ç°
- AMM V4 éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´

**å…³é”®æ´å¯Ÿï¼š**
PDA ç­¾ååªèƒ½åœ¨åˆçº¦ç«¯æä¾›ï¼Œå› æ­¤ä»»ä½•éœ€è¦ PDA ç­¾åçš„æ“ä½œï¼ˆå¦‚å…³é—­ PDA æ‹¥æœ‰çš„è´¦æˆ·ï¼‰éƒ½å¿…é¡»åœ¨ Rust ç«¯å®Œæˆã€‚
